# 生产环境配置清单

> **重要说明**：以下所有环境变量必须在生产服务器上配置，缺少任何一个都会导致系统功能异常。

---

## 1. 必需环境变量（Critical）

### 1.1 数据库配置
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `DATABASE_URL` | PostgreSQL连接字符串 | `postgresql://user:pass@host:5432/dbname?sslmode=require` | `server/db.ts:15`<br>`drizzle.config.ts:12` |

**重要性**：🔴 必需  
**验证方法**：
```bash
# 测试数据库连接
psql $DATABASE_URL -c "SELECT version();"
```

---

### 1.2 JWT配置
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `JWT_SECRET` | JWT签名密钥（至少32位随机字符串） | `your-super-secret-jwt-key-min-32-chars` | `server/routes.ts:42` |
| `JWT_EXPIRES_IN` | Token过期时间（可选，默认7天） | `7d` | `server/routes.ts:586` |

**重要性**：🔴 必需  
**生成强密钥**：
```bash
# 生成随机密钥
openssl rand -base64 32
```

---

### 1.3 阿里云OSS配置（对象存储）
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `OSS_REGION` | OSS区域 | `ap-southeast-1` 或 `oss-ap-southeast-1` | `server/services/aliOssService.ts:9` |
| `OSS_ACCESS_KEY_ID` | OSS Access Key ID | `LTAI***************` | `server/services/aliOssService.ts:18` |
| `OSS_ACCESS_KEY_SECRET` | OSS Access Key Secret | `************************` | `server/services/aliOssService.ts:19` |
| `OSS_BUCKET` | OSS存储桶名称 | `prodee-h5-assets` | `server/services/aliOssService.ts:20` |
| `OSS_ENDPOINT`（可选） | OSS自定义域名 | `oss-ap-southeast-1.aliyuncs.com` | `server/services/aliOssService.ts:17` |

**重要性**：🔴 必需（媒体上传功能依赖）  
**兼容性**：支持 `OSS_*` 或 `ALI_OSS_*` 前缀（代码会自动兼容）

**验证方法**：
```bash
# 使用阿里云CLI验证
ossutil ls oss://$OSS_BUCKET --endpoint $OSS_ENDPOINT
```

---

### 1.4 LINE Platform配置

#### 普通用户OA（H5活动页）
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `LINE_CHANNEL_ID` | LINE Login Channel ID | `1234567890` | `server/services/lineService.ts:33,67` |
| `LINE_CHANNEL_SECRET` | LINE Login Channel Secret | `abcdef1234567890abcdef` | `server/services/lineService.ts:68` |
| `LIFF_ID` | LIFF应用ID（H5活动页） | `2008410104-YJ9V8QnR` | 前端通过 `/api/config` 获取 |

**重要性**：🔴 必需（用户登录功能依赖）  
**配置位置**：LINE Developers Console → LINE Login Channel

---

#### 店员OA（如果使用独立OA）
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `LINE_LOGIN_CHANNEL_ID`（可选） | 店员登录Channel ID | `1234567891` | `client/src/pages/user/StaffBind.tsx:131` |

**说明**：如果店员和普通用户使用同一个LINE OA，则不需要此变量。

---

### 1.5 OpenAI配置（自动翻译）
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `AI_INTEGRATIONS_OPENAI_BASE_URL` | OpenAI API地址 | `https://api.openai.com/v1` | `server/services/translationService.ts:5` |
| `AI_INTEGRATIONS_OPENAI_API_KEY` | OpenAI API Key | `sk-proj-***************` | `server/services/translationService.ts:6` |

**重要性**：🟡 重要（活动自动翻译功能依赖）  
**替代方案**：如果不配置，需要管理员手动填写三语言内容

---

### 1.6 Google Maps配置（门店地址搜索）
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `GOOGLE_MAPS_API_KEY` | Google Maps API Key | `AIzaSy***************` | `server/services/googleMapsService.ts:3` |

**重要性**：🟡 重要（门店地址自动补全功能依赖）  
**替代方案**：如果不配置，需要管理员手动输入门店地址

---

### 1.7 Session配置
| 变量名 | 说明 | 示例值 | 使用位置 |
|--------|------|--------|----------|
| `SESSION_SECRET` | Express Session密钥 | `your-session-secret-key` | `server/routes.ts:267` |

**重要性**：🟢 推荐（LINE OAuth状态验证依赖）  
**默认值**：如果不配置，会使用默认值（不推荐）

---

## 2. 环境变量配置方法

### 2.1 开发环境（.env.development）
**位置**：项目根目录创建 `.env.development` 文件

```bash
# 数据库
DATABASE_URL=postgresql://user:pass@localhost:5432/goodpick_dev

# JWT
JWT_SECRET=dev-jwt-secret-change-in-production
JWT_EXPIRES_IN=7d

# 阿里云OSS
OSS_REGION=ap-southeast-1
OSS_ACCESS_KEY_ID=YOUR_OSS_KEY_ID
OSS_ACCESS_KEY_SECRET=YOUR_OSS_KEY_SECRET
OSS_BUCKET=prodee-h5-assets

# LINE Platform
LINE_CHANNEL_ID=1234567890
LINE_CHANNEL_SECRET=abcdef1234567890
LIFF_ID=2008410104-YJ9V8QnR

# OpenAI
AI_INTEGRATIONS_OPENAI_BASE_URL=https://api.openai.com/v1
AI_INTEGRATIONS_OPENAI_API_KEY=sk-proj-***

# Google Maps
GOOGLE_MAPS_API_KEY=AIzaSy***

# Session
SESSION_SECRET=dev-session-secret
```

---

### 2.2 生产环境（阿里云ECS）

#### 方法1：使用 .env.production 文件
**位置**：服务器项目根目录

```bash
# 创建生产环境配置文件
vim /var/www/goodpick-go/.env.production

# 粘贴环境变量（与开发环境相同格式，但使用生产值）
```

#### 方法2：使用系统环境变量
**位置**：`/etc/environment` 或 `~/.bashrc`

```bash
# 编辑系统环境变量
sudo vim /etc/environment

# 添加环境变量
export DATABASE_URL="postgresql://user:pass@rds-host:5432/goodpick_prod?sslmode=require"
export JWT_SECRET="prod-jwt-secret-32-chars-minimum"
# ... 其他变量
```

#### 方法3：使用PM2配置文件（推荐）
**位置**：`ecosystem.config.js`

```javascript
module.exports = {
  apps: [{
    name: 'goodpick-go',
    script: './dist/index.js',
    instances: 2,
    exec_mode: 'cluster',
    env_production: {
      NODE_ENV: 'production',
      DATABASE_URL: 'postgresql://user:pass@rds-host:5432/goodpick_prod',
      JWT_SECRET: 'prod-jwt-secret-32-chars',
      OSS_REGION: 'ap-southeast-1',
      OSS_ACCESS_KEY_ID: 'LTAI***',
      OSS_ACCESS_KEY_SECRET: '***',
      OSS_BUCKET: 'prodee-h5-assets',
      LINE_CHANNEL_ID: '1234567890',
      LINE_CHANNEL_SECRET: 'abcdef1234567890',
      LIFF_ID: '2008410104-YJ9V8QnR',
      AI_INTEGRATIONS_OPENAI_BASE_URL: 'https://api.openai.com/v1',
      AI_INTEGRATIONS_OPENAI_API_KEY: 'sk-proj-***',
      GOOGLE_MAPS_API_KEY: 'AIzaSy***',
      SESSION_SECRET: 'prod-session-secret'
    }
  }]
}
```

**启动命令**：
```bash
pm2 start ecosystem.config.js --env production
```

---

## 3. 前端环境变量（Vite）

**重要说明**：前端环境变量必须以 `VITE_` 前缀，编译时会被嵌入到静态文件中。

### 3.1 当前使用的前端变量
| 变量名 | 说明 | 使用位置 |
|--------|------|----------|
| `VITE_LINE_CHANNEL_ID` | LINE Channel ID（前端使用） | `client/src/pages/user/MyCoupons.tsx:154` |

**配置方法**：
```bash
# .env.production
VITE_LINE_CHANNEL_ID=1234567890
```

**注意**：前端当前主要通过 `/api/config` 接口获取配置，不依赖编译时环境变量。

---

## 4. 环境变量验证清单

### 4.1 数据库连接测试
```bash
psql $DATABASE_URL -c "SELECT version();"
```

### 4.2 阿里云OSS测试
```bash
# 使用Node.js测试
node -e "
const OSS = require('ali-oss');
const client = new OSS({
  region: process.env.OSS_REGION,
  accessKeyId: process.env.OSS_ACCESS_KEY_ID,
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET,
  bucket: process.env.OSS_BUCKET
});
client.list().then(console.log);
"
```

### 4.3 LINE配置测试
访问前端接口：
```bash
curl https://your-domain.com/api/config
# 应返回：{"success":true,"data":{"liffId":"2008410104-YJ9V8QnR","lineChannelId":"1234567890"}}
```

### 4.4 OpenAI配置测试
```bash
curl $AI_INTEGRATIONS_OPENAI_BASE_URL/models \
  -H "Authorization: Bearer $AI_INTEGRATIONS_OPENAI_API_KEY"
```

---

## 5. 安全建议

### 5.1 敏感信息保护
- ✅ 不要将 `.env` 文件提交到Git仓库（已在 `.gitignore`）
- ✅ 使用强随机密钥（JWT_SECRET至少32位）
- ✅ 生产环境使用不同的密钥（不要与开发环境相同）
- ✅ 定期轮换API密钥（建议每季度）

### 5.2 文件权限
```bash
# 限制.env文件权限（仅所有者可读）
chmod 600 .env.production
chown www-data:www-data .env.production
```

### 5.3 环境隔离
```
开发环境：.env.development
测试环境：.env.test
生产环境：.env.production（或系统环境变量）
```

---

## 6. 故障排查

### 6.1 数据库连接失败
**症状**：服务启动报错 `DATABASE_URL must be set`  
**排查**：
```bash
echo $DATABASE_URL
# 如果为空，检查环境变量加载
```

### 6.2 LINE登录失败
**症状**：前端显示 "LIFF initialization failed"  
**排查**：
1. 检查 `/api/config` 接口返回的 `liffId`
2. 确认LINE Developers控制台的LIFF ID正确
3. 检查域名是否添加到LIFF白名单

### 6.3 媒体上传失败
**症状**：管理后台上传图片/视频报错  
**排查**：
```bash
# 检查OSS环境变量
env | grep OSS
# 测试OSS连接
node server/services/aliOssService.ts
```

### 6.4 OpenAI翻译失败
**症状**：创建活动时自动翻译不工作  
**排查**：
```bash
# 检查OpenAI API Key
curl $AI_INTEGRATIONS_OPENAI_BASE_URL/models \
  -H "Authorization: Bearer $AI_INTEGRATIONS_OPENAI_API_KEY"
```

---

## 7. 环境变量完整清单

### 必需变量（🔴 Critical）
- [x] `DATABASE_URL`
- [x] `JWT_SECRET`
- [x] `OSS_REGION`
- [x] `OSS_ACCESS_KEY_ID`
- [x] `OSS_ACCESS_KEY_SECRET`
- [x] `OSS_BUCKET`
- [x] `LINE_CHANNEL_ID`
- [x] `LINE_CHANNEL_SECRET`
- [x] `LIFF_ID`

### 推荐变量（🟡 Important）
- [x] `AI_INTEGRATIONS_OPENAI_BASE_URL`
- [x] `AI_INTEGRATIONS_OPENAI_API_KEY`
- [x] `GOOGLE_MAPS_API_KEY`
- [x] `SESSION_SECRET`

### 可选变量（🟢 Optional）
- [ ] `JWT_EXPIRES_IN`（默认7天）
- [ ] `OSS_ENDPOINT`（默认自动生成）
- [ ] `LINE_LOGIN_CHANNEL_ID`（如果使用独立店员OA）
- [ ] `VITE_LINE_CHANNEL_ID`（前端使用，可选）

---

**清单版本**：v1.0  
**更新日期**：2025-11-08  
**维护人员**：开发团队
