# GoodPick Go 系统总览文档

## 1. 前端技术栈

### 核心框架
- **React 18** + **TypeScript**：构建用户界面
- **Vite**：构建工具和开发服务器
- **Wouter**：轻量级客户端路由

### UI/UX 组件库
- **Shadcn/ui** + **Radix UI**：无障碍UI组件
- **Tailwind CSS**：工具优先的CSS框架
- **Lucide React**：图标库
- **Framer Motion**：动画库

### 状态管理
- **TanStack Query (React Query)**：服务器状态管理
- **React Context API**：全局状态（认证、语言）
- **React Hooks**：本地状态

### 专用库
- **html5-qrcode**：二维码扫描（店员核销）
- **qrcode**：二维码生成（优惠券展示）
- **react-dropzone**：文件上传
- **recharts**：数据可视化（Dashboard）
- **LINE LIFF SDK**：LINE小程序集成

---

## 2. 前端路由结构

### 2.1 管理后台路由（需要管理员认证）
| 路径 | 页面 | 功能 |
|------|------|------|
| `/admin` | 重定向 | 自动跳转到 `/admin/login` |
| `/admin/login` | 管理员登录 | 邮箱密码登录 |
| `/admin/stores` | 门店管理 | 增删改查门店、Google Maps集成 |
| `/admin/campaigns` | 活动管理 | 创建/编辑活动、OpenAI翻译、媒体上传 |
| `/admin/coupons` | 优惠券管理 | 查看/搜索优惠券领取记录 |
| `/admin/dashboard` | 运营后台 | 统计数据、活动/品牌/门店分析 |
| `/admin/staff-presets` | 员工管理 | 添加员工、生成授权二维码 |

### 2.2 普通用户 H5 路由
| 路径 | 页面 | 功能 |
|------|------|------|
| `/` | 根路径 | 重定向到 `/campaign/1` |
| `/campaign/:id` | 活动详情 | 查看活动、LINE登录、领券 |
| `/my-coupons` | 我的优惠券 | 查看已领优惠券、二维码展示 |

### 2.3 店员 H5 路由（需要店员认证）
| 路径 | 页面 | 功能 |
|------|------|------|
| `/staff/bind` | 店员绑定 | 扫描授权二维码、LINE登录、手机号验证 |
| `/staff/redeem` | 核销页面 | 扫码核销/手动输入8位核销码 |
| `/staff/campaign` | 活动列表 | 查看本店参与的活动 |
| `/staff/campaign/:id` | 活动详情 | 查看活动规则、培训视频 |
| `/staff/stats` | 我的数据 | 今日/本周/本月核销统计 |

---

## 3. 三种身份的认证流程

### 3.1 管理员认证（Admin）
**流程**：
1. 用户访问 `/admin/login`，输入邮箱和密码
2. 前端调用 `POST /api/admin/login`，后端验证密码（bcryptjs）
3. 后端生成JWT Token（包含 `id`, `email`, `type: 'admin'`）
4. 前端存储Token到 `localStorage.adminToken`，存储用户信息到 `localStorage.admin`
5. 后续请求通过 `Authorization: Bearer <token>` 头部携带Token
6. 后端 `adminAuthMiddleware` 验证Token和 `type === 'admin'`

**JWT Payload**：
```json
{
  "id": 1,
  "email": "admin@example.com",
  "type": "admin",
  "iat": 1234567890,
  "exp": 1234567890
}
```

### 3.2 普通用户认证（User - LINE登录）
**流程**：
1. 用户点击"立即领取"按钮触发 `handleLiffLogin()`
2. 前端初始化LIFF SDK（`liff.init({ liffId })`）
3. 检查LIFF登录状态（`liff.isLoggedIn()`）
   - 未登录：调用 `liff.login()` 跳转LINE授权页面
   - 已登录：获取ID Token（`liff.getIDToken()`）
4. 前端调用 `POST /api/auth/line/login`，传递ID Token
5. 后端验证LINE ID Token（调用LINE API）
6. 后端在数据库创建/更新用户记录（`users`表）
7. 后端生成JWT Token（包含 `id`, `lineUserId`, `type: 'user'`）
8. 前端存储Token到 `localStorage.userToken`，存储用户信息到 `localStorage.user`

**JWT Payload**：
```json
{
  "id": 123,
  "lineUserId": "U1234567890abcdef",
  "type": "user",
  "iat": 1234567890,
  "exp": 1234567890
}
```

**重要约束**：
- 禁止自动登录：`AuthContext.tsx` 只从 `localStorage` 恢复状态，不自动触发LINE登录
- LIFF初始化：在 `CampaignDetail.tsx` 按需初始化，避免页面导航时重复初始化

### 3.3 店员认证（Staff - LINE登录 + 手机号验证）
**流程**：
1. 管理员在后台添加员工预设（`staff_presets`表），生成授权二维码
2. 店员扫描二维码，跳转到 `/staff/bind?token=<authToken>`
3. 店员点击"授权绑定"按钮，触发LINE OAuth流程
4. LINE回调返回授权码，后端交换Access Token和ID Token
5. 后端验证ID Token，获取用户LINE Profile（包含手机号）
6. 后端验证手机号是否与预设的 `staffPresets.phone` 一致
7. 验证通过后，更新 `staffPresets` 表（`isBound=true`, `boundUserId=用户ID`）
8. 后端生成JWT Token（与普通用户相同，`type: 'user'`）
9. 后续店员端API请求通过 `staffAuthMiddleware` 验证：
   - 验证JWT Token
   - 查询 `staff_presets` 表确认用户已绑定店员身份
   - 在 `req.staffInfo` 中注入 `storeId`, `staffId`, `name`

**JWT Payload**（与普通用户相同）：
```json
{
  "id": 123,
  "lineUserId": "U1234567890abcdef",
  "type": "user",
  "iat": 1234567890,
  "exp": 1234567890
}
```

**权限验证**：
- `staffAuthMiddleware` 通过 `boundUserId` 关联确认店员身份
- 店员只能核销本店参与的活动优惠券（通过 `campaign_stores` 表验证）

---

## 4. 主要后端 API 列表

### 4.1 认证相关 API

| 路径 | 方法 | 认证 | 功能 | 入参 | 出参 |
|------|------|------|------|------|------|
| `/api/admin/login` | POST | 无 | 管理员登录 | `{ email, password }` | `{ success, token, admin }` |
| `/api/auth/line/login` | POST | 无 | 用户LINE登录 | `{ idToken }` | `{ success, token, user }` |
| `/api/auth/line/init-oauth` | GET | 无 | 初始化LINE OAuth | `?redirectPath` | 重定向到LINE授权页 |
| `/api/auth/line/callback` | GET | 无 | LINE OAuth回调 | `?code&state` | 重定向到前端并设置Token |
| `/api/user/verify` | GET | User Token | 验证用户Token | Header: `Authorization` | `{ success, user }` |
| `/api/config` | GET | 无 | 获取前端配置 | 无 | `{ liffId, lineChannelId }` |

### 4.2 管理后台 API（需要 Admin Token）

#### 门店管理
| 路径 | 方法 | 功能 | 入参 | 出参 |
|------|------|------|------|------|
| `/api/admin/stores` | GET | 获取门店列表 | Query: `?brand&city&search` | `{ success, data: stores[] }` |
| `/api/admin/stores` | POST | 创建门店 | `{ name, brand, city, address, ... }` | `{ success, data: store }` |
| `/api/admin/stores/:id` | PUT | 更新门店 | `{ name, brand, ... }` | `{ success, data: store }` |
| `/api/admin/stores/:id` | DELETE | 删除门店 | 无 | `{ success }` |
| `/api/admin/places/autocomplete` | GET | Google地点自动补全 | Query: `?input` | `{ success, predictions }` |
| `/api/admin/places/details/:placeId` | GET | 获取地点详情 | 无 | `{ success, data }` |

#### 活动管理
| 路径 | 方法 | 功能 | 入参 | 出参 |
|------|------|------|------|------|
| `/api/admin/campaigns` | GET | 获取活动列表 | Query: `?status&search` | `{ success, data: campaigns[] }` |
| `/api/admin/campaigns` | POST | 创建活动 | `{ title*, description*, ... }` | `{ success, data: campaign }` |
| `/api/admin/campaigns/:id` | PUT | 更新活动 | `{ title, description, ... }` | `{ success, data: campaign }` |
| `/api/admin/campaigns/:id` | DELETE | 删除活动 | 无 | `{ success }` |
| `/api/admin/campaigns/:id/stores` | GET | 获取活动关联门店 | 无 | `{ success, data: stores[] }` |
| `/api/admin/campaigns/:id/stores` | POST | 更新活动关联门店 | `{ storeIds: number[] }` | `{ success }` |
| `/api/admin/campaigns/:id/staff-guide` | PUT | 更新员工指导 | `{ staffInstructions, staffTraining, staffTrainingMediaUrls }` | `{ success, data: campaign }` |

#### 员工管理
| 路径 | 方法 | 功能 | 入参 | 出参 |
|------|------|------|------|------|
| `/api/admin/stores/:storeId/staff-presets` | GET | 获取门店员工列表 | 无 | `{ success, data: presets[] }` |
| `/api/admin/stores/:storeId/staff-presets` | POST | 添加员工 | `{ name, staffId, phone }` | `{ success, data: preset, qrCodeUrl }` |
| `/api/admin/staff-presets/:presetId` | DELETE | 删除员工 | 无 | `{ success }` |
| `/api/admin/staff-presets/:presetId/unbind` | POST | 解绑员工 | 无 | `{ success }` |

#### Dashboard统计
| 路径 | 方法 | 功能 | 入参 | 出参 |
|------|------|------|------|------|
| `/api/admin/dashboard/stats` | GET | 核心统计数据 | Query: `?timeRange` | `{ success, data: { overview, campaigns, brands, stores } }` |

#### 媒体上传
| 路径 | 方法 | 功能 | 入参 | 出参 |
|------|------|------|------|------|
| `/api/upload/campaign-media` | POST | 上传活动媒体 | FormData: `file` | `{ success, url }` |

### 4.3 用户端 API（需要 User Token 或可选认证）

| 路径 | 方法 | 认证 | 功能 | 入参 | 出参 |
|------|------|------|------|------|------|
| `/api/campaigns` | GET | 可选 | 获取活动列表 | 无 | `{ success, data: campaigns[] }` |
| `/api/campaigns/:id` | GET | 可选 | 获取活动详情 | 无 | `{ success, data: { campaign, stores, userClaimedCount } }` |
| `/api/campaigns/:id/claim` | POST | 必需 | 领取优惠券 | `{ channel }` | `{ success, data: coupon }` |
| `/api/me/coupons` | GET | 必需 | 获取我的优惠券 | Query: `?status` | `{ success, data: coupons[] }` |

### 4.4 店员端 API（需要 Staff 认证）

| 路径 | 方法 | 功能 | 入参 | 出参 |
|------|------|------|------|------|
| `/api/staff/bind` | POST | 绑定店员身份 | `{ token, userToken }` | `{ success, data: { staffName, staffId, storeId } }` |
| `/api/staff/summary` | GET | 获取核销统计 | 无 | `{ success, data: { today, thisWeek, thisMonth } }` |
| `/api/staff/recent-redemptions` | GET | 获取最近核销记录 | Query: `?limit` | `{ success, data: redemptions[] }` |
| `/api/staff/campaigns` | GET | 获取本店活动列表 | 无 | `{ success, data: campaigns[] }` |
| `/api/staff/redeem/query` | POST | 查询优惠券 | `{ code }` | `{ success, data: { coupon, campaign, user } }` |
| `/api/staff/redeem/execute` | POST | 执行核销 | `{ couponId }` | `{ success, data: coupon }` |

### 4.5 特殊API

| 路径 | 方法 | 功能 | 说明 |
|------|------|------|------|
| `/api/media/video/:objectKey(*)` | GET | 视频代理 | 代理阿里云OSS视频，移除强制下载头，支持Range请求 |

---

## 5. 数据库表结构

### 5.1 admins（管理员表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| email | text | 邮箱（唯一） |
| password | text | 密码哈希（bcryptjs） |
| name | text | 管理员姓名 |
| isActive | boolean | 是否激活 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 5.2 stores（门店表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| name | text | 门店名称 |
| brand | text | 品牌名称 |
| city | text | 城市（用于筛选） |
| address | text | 详细地址 |
| latitude | decimal(10,7) | 纬度 |
| longitude | decimal(10,7) | 经度 |
| phone | text | 联系电话 |
| rating | decimal(2,1) | 评分 |
| imageUrl | text | 门店图片 |
| floorInfo | text | 楼层信息（室内导航） |
| isActive | boolean | 是否激活 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 5.3 campaigns（活动表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| titleSourceLang | enum | 标题源语言（zh-cn/en-us/th-th） |
| titleSource | text | 标题源文本 |
| titleZh | text | 中文标题（OpenAI翻译） |
| titleEn | text | 英文标题（OpenAI翻译） |
| titleTh | text | 泰文标题（OpenAI翻译） |
| descriptionSourceLang | enum | 描述源语言 |
| descriptionSource | text | 描述源文本 |
| descriptionZh | text | 中文描述 |
| descriptionEn | text | 英文描述 |
| descriptionTh | text | 泰文描述 |
| bannerImageUrl | text | 横幅图片URL |
| mediaUrls | text[] | 媒体文件URL数组 |
| couponValue | decimal(10,2) | 优惠券面额 |
| discountType | enum | 折扣类型（percentage_off/fixed_amount/fixed_price/free_item） |
| originalPrice | decimal(10,2) | 原价（用于计算折扣） |
| startAt | timestamp | 开始时间 |
| endAt | timestamp | 结束时间 |
| maxPerUser | integer | 每人限领数量 |
| maxTotal | integer | 总库存（null=无限） |
| currentClaimed | integer | 当前已领数量 |
| channel | enum | 推广渠道（line_oa/line_group/facebook/other） |
| staffInstructions | text | 员工操作说明 |
| staffTraining | text | 员工培训内容 |
| staffTrainingMediaUrls | text[] | 培训视频URL数组 |
| isActive | boolean | 是否激活 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 5.4 campaign_stores（活动-门店关联表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| campaignId | integer | 活动ID（外键，级联删除） |
| storeId | integer | 门店ID（外键，级联删除） |

### 5.5 users（用户表 - LINE用户）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| lineUserId | text | LINE用户ID（唯一） |
| displayName | text | 显示名称 |
| avatarUrl | text | 头像URL |
| phone | text | 手机号（从LINE Profile获取，用于店员绑定验证） |
| language | enum | 偏好语言（zh-cn/en-us/th-th） |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

### 5.6 coupons（优惠券表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| userId | integer | 用户ID（外键，级联删除） |
| campaignId | integer | 活动ID（外键，级联删除） |
| code | text | 8位数字核销码（唯一） |
| status | enum | 状态（unused/used/expired） |
| issuedAt | timestamp | 发放时间 |
| usedAt | timestamp | 使用时间 |
| expiredAt | timestamp | 过期时间 |
| channel | enum | 领取渠道（line_oa/line_group/facebook/other） |
| redeemedStoreId | integer | 核销门店ID（外键） |
| notes | text | 备注 |

### 5.7 media_files（媒体文件表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| fileName | text | 文件名 |
| fileUrl | text | 文件URL（阿里云OSS） |
| fileType | text | 文件类型（image/video） |
| fileSize | integer | 文件大小（字节） |
| uploadedBy | integer | 上传者ID（管理员外键） |
| isPublic | boolean | 是否公开 |
| createdAt | timestamp | 创建时间 |

### 5.8 staff_presets（员工预设表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | serial | 主键 |
| storeId | integer | 门店ID（外键，级联删除） |
| name | text | 员工姓名 |
| staffId | text | 员工工号 |
| phone | text | 手机号（用于绑定验证） |
| authToken | text | 授权令牌（唯一，用于生成二维码） |
| isBound | boolean | 是否已绑定LINE账号 |
| boundUserId | integer | 绑定的用户ID（外键） |
| boundAt | timestamp | 绑定时间 |
| createdAt | timestamp | 创建时间 |
| updatedAt | timestamp | 更新时间 |

---

## 6. 关键技术实现

### 6.1 多语言系统
- **OpenAI自动翻译**：管理员创建活动时，使用GPT-4o-mini将标题/描述翻译为中文/英文/泰文
- **界面语言切换**：
  1. URL参数 `?lang=zh-cn` 最高优先级
  2. localStorage存储用户手动选择
  3. 浏览器语言自动检测（`navigator.language`）
  4. 默认泰语（`th-th`）

### 6.2 视频处理
- **阿里云OSS视频快照**：使用 `?x-oss-process=video/snapshot,t_0,f_jpg,w_800` 生成封面图
- **视频代理**：`/api/media/video/:objectKey` 代理OSS视频，移除强制下载头，支持Range请求

### 6.3 优惠券核销
- **8位数字核销码**：`nanoid('0123456789', 8)` 生成唯一核销码
- **二维码展示**：用户端使用 `qrcode` 库生成二维码
- **扫码核销**：店员端使用 `html5-qrcode` 调用摄像头扫描
- **权限验证**：通过 `campaign_stores` 表验证店员只能核销本店活动优惠券

### 6.4 Dashboard统计
- **SQL优化**：使用 `COUNT(DISTINCT coupon.id)` 避免多表JOIN重复计数
- **时间范围筛选**：支持今日/本周/本月/自定义时间段统计
- **三维数据**：活动维度、品牌维度、门店维度统计

---

## 7. 部署架构

### 开发环境
- **前端**：Vite Dev Server（端口5000）
- **后端**：Express服务器（同端口5000）
- **数据库**：Neon Serverless PostgreSQL
- **对象存储**：阿里云OSS（新加坡）

### 生产环境建议
- **服务器**：阿里云新加坡 ECS（Node.js环境）
- **数据库**：阿里云RDS PostgreSQL 或 Docker PostgreSQL
- **进程管理**：PM2守护进程
- **反向代理**：Nginx（可选）
- **SSL证书**：Let's Encrypt
- **域名**：配置LINE Developers回调URL

---

## 8. 安全措施

### 认证安全
- JWT Secret从环境变量读取
- 密码使用bcryptjs哈希存储
- LINE ID Token服务器端验证
- 店员绑定需要手机号匹配验证

### API安全
- 所有管理后台API需要Admin Token
- 所有用户操作API需要User Token
- 店员API需要Staff认证（绑定验证）
- 输入验证使用Zod Schema

### 数据安全
- 数据库连接使用SSL（Neon）
- 敏感信息不记录到日志
- CORS配置限制请求来源
- 视频代理限制只允许 `public/*` 路径

---

## 9. 已知限制和待优化项

### 当前限制
1. JWT无设备绑定，支持多设备同时登录
2. 优惠券过期时间固定为活动结束时间
3. 视频文件大小限制（阿里云OSS配置）
4. Dashboard统计在多门店活动场景下需要性能测试

### 待优化（TODO）
1. 添加优惠券使用推送通知（LINE Messaging API）
2. 支持优惠券退款/作废功能
3. 添加活动预约功能
4. 支持多管理员角色权限分离
5. 添加用户行为分析（Google Analytics）
6. 优化移动端性能（Code Splitting）

---

**文档版本**：v1.0  
**更新日期**：2025-11-08  
**维护人员**：开发团队
