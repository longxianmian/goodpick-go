# 调试日志清理建议列表

> **重要说明**：以下是建议删除的调试日志清单，请在确认后再执行删除操作。部分服务器日志可能需要保留用于生产环境问题排查。

---

## 1. 前端调试日志（建议全部删除）

### 1.1 client/src/App.tsx
**位置**：154, 174, 183行
```typescript
// 建议删除：
console.log('[App] App组件挂载 at', new Date().toISOString());
console.log('[App] 配置加载完成，LIFF ID =', data.data?.liffId);
console.log('[App] App组件卸载 at', new Date().toISOString());
```
**原因**：这些是调试App生命周期的日志，生产环境不需要。

---

### 1.2 client/src/pages/user/CampaignDetail.tsx
**位置**：233, 236, 241, 247, 258, 344, 448行
```typescript
// 建议删除：
console.log('[handleLiffLogin] 开始按需初始化 LIFF');
console.log('[handleLiffLogin] LIFF 初始化完成');
console.log('[handleLiffLogin] 用户未登录，跳转 LIFF 登录');
console.log('[handleLiffLogin] 用户已登录 LIFF，获取 ID Token');
console.log('[handleLiffLogin] 后端登录成功');
console.log('[handleClaim] Token失效，清除localStorage并重新登录');
console.log('[按钮显示调试]', { isUserAuthenticated, userClaimedCount, ... });
```
**原因**：这些是LIFF登录流程和按钮显示逻辑的调试日志，功能已稳定。

---

### 1.3 client/src/contexts/LanguageContext.tsx
**位置**：1482, 1490, 1514, 1522, 1531, 1540, 1544, 1552, 1554, 1558, 1569行
```typescript
// 建议删除：
console.log(`[语言初始化] 使用URL参数: ${normalizedLang}`);
console.log(`[语言初始化] 使用localStorage: ${stored}`);
console.log(`[语言初始化] 检测到浏览器语言 ${browserLang}，使用: ${detectedLang}`);
console.log(`[语言初始化] 使用默认语言: ${defaultLang}`);
console.log(`[同步修复] localStorage(${stored}) 与 state(${language}) 不一致，立即修复`);
console.log(`[跨窗口同步] 检测到其他窗口切换语言: ${e.oldValue} -> ${e.newValue}`);
console.log(`[跨窗口同步] 已清除所有查询缓存，页面会自动重新获取数据`);
console.log(`[setLanguage] 切换语言: ${lang}`);
console.log(`[setLanguage] 切换前localStorage: ${oldValue}`);
console.log(`[setLanguage] localStorage已立即保存为: ${localStorage.getItem('language')}`);
console.log(`[setLanguage] 已手动触发storage事件，其他窗口会收到通知`);
```
**原因**：这些是语言切换和同步逻辑的调试日志，系统已稳定运行，生产环境不需要。

---

## 2. 后端调试日志（部分保留，部分删除）

### 2.1 server/routes.ts - 建议保留的日志
**位置**：189行（核销码冲突检测）
```typescript
// ✅ 建议保留：
console.log(`[核销码冲突] ${code} 已存在，重新生成...`);
```
**原因**：核销码冲突是低概率事件，保留日志便于监控。

---

**位置**：674-675, 724-725行（LINE OAuth和员工绑定成功）
```typescript
// ✅ 建议保留：
console.log('✅ LINE OAuth成功，用户:', { lineUserId: lineProfile.sub, ... });
console.log('✅ 员工绑定成功，跳转到工作台', { staffId: staffPreset.staffId, ... });
```
**原因**：这些是关键业务成功日志，便于问题排查。

---

**位置**：1252-1253, 1369-1370, 1404行（核销权限和成功日志）
```typescript
// ✅ 建议保留：
console.log(`[核销权限拒绝] 店员 ${staffInfo.name} (门店ID: ${staffInfo.storeId}) 尝试核销不属于本店的优惠券 ${coupon.code}`);
console.log(`[核销成功] 优惠券ID: ${couponId}, 核销码: ${coupon.code}, 店员: ${staffInfo.name}, 门店ID: ${staffInfo.storeId}`);
```
**原因**：核销操作是核心业务，需要保留日志用于审计和问题排查。

---

### 2.2 server/routes.ts - 建议删除的日志
**位置**：276, 789行（API请求日志）
```typescript
// ❌ 建议删除：
console.log('[API]', new Date().toISOString(), req.method, req.path, 'session=', sessionId, 'ua=', ua);
```
**原因**：这些是通用API请求日志，频繁触发，建议改用生产环境的日志框架（如Winston、Morgan）。

---

**位置**：879, 889, 894, 898, 904, 909, 911, 921, 923, 929, 949行（领券流程详细日志）
```typescript
// ❌ 建议删除（或改为仅记录错误）：
console.log(`[领券请求] 用户ID: ${userId}, 活动ID: ${campaignId}, 渠道: ${channel}`);
console.log(`[领券失败] 活动不存在或已停用 - 活动ID: ${campaignId}`);
console.log(`[活动时间检查] 当前时间: ${now.toISOString()}, 开始时间: ${campaign.startAt.toISOString()}, ...`);
console.log(`[领券失败] 活动未开始 - 活动ID: ${campaignId}`);
console.log(`[领券失败] 活动已结束 - 活动ID: ${campaignId}`);
console.log(`[库存检查] 当前已领: ${campaign.currentClaimed}, 总库存: ${campaign.maxTotal || '无限制'}`);
console.log(`[领券失败] 优惠券已发完 - 活动ID: ${campaignId}`);
console.log(`[用户限制检查] 已领: ${userCoupons.length}, 限领: ${campaign.maxPerUser}`);
console.log(`[领券失败] 已达到个人限领数量 - 用户ID: ${userId}, 活动ID: ${campaignId}`);
console.log(`[生成优惠券] 8位数核销码: ${code}`);
console.log(`[领券成功] 用户ID: ${userId}, 活动ID: ${campaignId}, 优惠券ID: ${newCoupon.id}, 新的已领数: ${campaign.currentClaimed + 1}`);
```
**建议**：改为仅记录失败/异常情况，成功情况不记录（或使用更轻量级的日志级别）。

---

## 3. 其他文件的日志（建议检查）

### 3.1 server/services/*.ts
**文件**：`aliOssService.ts`, `translationService.ts`, `lineService.ts`, `googleMapsService.ts`

**建议**：
- 检查是否有调试用的 `console.log`
- 保留错误日志（`console.error`）
- 建议改用统一的日志框架（Winston）

---

### 3.2 client/src/pages/user/MyCoupons.tsx, StaffBind.tsx
**建议**：检查是否有与 `CampaignDetail.tsx` 类似的LIFF登录调试日志，建议删除。

---

## 4. 建议的清理步骤

### 步骤1：全量搜索（手动确认）
```bash
# 搜索所有console.log
grep -rn "console\.log" client/src --include="*.tsx" --include="*.ts"
grep -rn "console\.log" server --include="*.ts"
```

### 步骤2：分批删除（需要确认）
1. **第一批（安全删除）**：
   - `client/src/App.tsx` 的3条日志
   - `client/src/pages/user/CampaignDetail.tsx` 的7条日志
   - `client/src/contexts/LanguageContext.tsx` 的11条日志

2. **第二批（谨慎删除）**：
   - `server/routes.ts` 的API请求日志（276, 789行）
   - `server/routes.ts` 的领券详细流程日志（建议改为仅记录错误）

3. **第三批（保留）**：
   - 核销码冲突日志
   - LINE OAuth成功日志
   - 员工绑定成功日志
   - 核销权限拒绝/成功日志

### 步骤3：替换为生产级日志（可选）
**安装Winston日志框架**：
```bash
npm install winston
```

**配置示例**（`server/logger.ts`）：
```typescript
import winston from 'winston';

export const logger = winston.createLogger({
  level: process.env.NODE_ENV === 'production' ? 'info' : 'debug',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple(),
  }));
}
```

---

## 5. 总结

### 前端日志统计
- **App.tsx**：3条（建议全删）
- **CampaignDetail.tsx**：7条（建议全删）
- **LanguageContext.tsx**：11条（建议全删）
- **其他页面**：待检查

**前端总计**：约21条建议删除

### 后端日志统计
- **API请求日志**：2条（建议删除或改用Morgan）
- **领券流程日志**：11条（建议改为仅记录错误）
- **核心业务日志**：5条（建议保留）

**后端总计**：约13条建议调整

---

**清理优先级**：
1. **高优先级**：前端所有调试日志（21条）
2. **中优先级**：后端API请求日志（2条）
3. **低优先级**：后端领券流程日志（建议优化而非删除）

**下一步操作**：
1. 请确认是否删除前端调试日志（21条）
2. 请确认是否替换后端日志为Winston框架
3. 请确认是否保留核心业务日志（核销、绑定等）
