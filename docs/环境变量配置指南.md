# GoodPick Go 环境变量配置指南

## 概述

本文档说明GoodPick Go项目在**非Replit环境**（如阿里云ECS、AWS EC2等）部署时所需的环境变量配置。

## 必需环境变量

以下环境变量**必须配置**，否则系统无法正常运行：

### 数据库配置
```bash
# PostgreSQL数据库连接URL
DATABASE_URL=postgresql://user:password@host:5432/database

# 或者分开配置
PGHOST=localhost
PGPORT=5432
PGUSER=goodpick_user
PGPASSWORD=your_password
PGDATABASE=goodpick_db
```

### JWT密钥
```bash
# JWT令牌签名密钥（建议使用32位以上随机字符串）
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# Session密钥
SESSION_SECRET=your-session-secret-change-this-in-production
```

### LINE平台配置
```bash
# LINE Channel ID（LINE Developers控制台获取）
LINE_CHANNEL_ID=your-line-channel-id

# LINE Channel Secret
LINE_CHANNEL_SECRET=your-line-channel-secret

# LINE LIFF ID（LIFF应用ID）
LIFF_ID=your-liff-id
```

### 阿里云OSS配置
```bash
# OSS访问密钥（阿里云RAM控制台获取）
OSS_ACCESS_KEY_ID=your-oss-access-key-id
OSS_ACCESS_KEY_SECRET=your-oss-access-key-secret

# OSS Bucket名称
OSS_BUCKET=your-bucket-name

# OSS区域
OSS_REGION=oss-ap-southeast-1

# OSS Endpoint（可选，默认根据region自动生成）
OSS_ENDPOINT=https://oss-ap-southeast-1.aliyuncs.com

# 对象存储配置
DEFAULT_OBJECT_STORAGE_BUCKET_ID=your-bucket-id
PUBLIC_OBJECT_SEARCH_PATHS=public
PRIVATE_OBJECT_DIR=.private
```

---

## 可选环境变量

以下环境变量为**可选配置**，不配置时系统仍可正常运行，但相关功能会被禁用。

### OpenAI翻译服务（可选）

```bash
# OpenAI API Key（用于活动内容自动翻译）
# ⚠️ 如果不配置，翻译功能将被禁用，活动创建时所有语言版本将使用原文
OPENAI_API_KEY=sk-your-openai-api-key

# OpenAI Base URL（可选，默认为 https://api.openai.com/v1）
OPENAI_BASE_URL=https://api.openai.com/v1
```

**翻译功能说明**：
- **配置OPENAI_API_KEY时**：管理后台创建活动时，系统会自动调用OpenAI GPT-4o-mini将活动标题和描述从源语言翻译为中文、英文、泰文
- **不配置OPENAI_API_KEY时**：
  - 系统启动时会显示：`⚠️ 未配置OPENAI_API_KEY，翻译功能已禁用，将使用原文作为翻译结果`
  - 活动创建时，所有语言版本（titleZh/titleEn/titleTh）都将使用原文填充
  - **系统仍可正常运行**，只是缺少自动翻译功能
  - 管理员可以在后台手动编辑各语言版本的内容

### Google Maps API（可选）

```bash
# Google Maps API Key（用于管理后台门店地址自动补全）
# 不配置时，门店地址需手动输入，无法使用地址搜索功能
GOOGLE_MAPS_API_KEY=your-google-maps-api-key
```

---

## 环境变量配置方式

### 方式1：使用.env文件（推荐）

在项目根目录创建`.env`文件：

```bash
# .env 文件示例
NODE_ENV=production

# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/goodpick_db

# JWT
JWT_SECRET=your-super-secret-jwt-key
SESSION_SECRET=your-session-secret

# LINE
LINE_CHANNEL_ID=1234567890
LINE_CHANNEL_SECRET=your-channel-secret
LIFF_ID=1234567890-abcdefgh

# 阿里云OSS
OSS_ACCESS_KEY_ID=LTAI5...
OSS_ACCESS_KEY_SECRET=xxx...
OSS_BUCKET=goodpick-assets
OSS_REGION=oss-ap-southeast-1
DEFAULT_OBJECT_STORAGE_BUCKET_ID=goodpick-assets
PUBLIC_OBJECT_SEARCH_PATHS=public
PRIVATE_OBJECT_DIR=.private

# OpenAI（可选，不配置则禁用翻译功能）
# OPENAI_API_KEY=sk-proj-xxx...

# Google Maps（可选）
# GOOGLE_MAPS_API_KEY=AIzaSy...
```

### 方式2：系统环境变量

在阿里云ECS或其他Linux服务器上，可以通过`export`命令设置：

```bash
export DATABASE_URL="postgresql://user:password@localhost:5432/goodpick_db"
export JWT_SECRET="your-jwt-secret"
export LINE_CHANNEL_ID="1234567890"
# ... 其他变量
```

为了持久化，可以添加到`~/.bashrc`或`~/.profile`文件中。

### 方式3：使用PM2生态系统文件

如果使用PM2管理Node.js进程，可以在`ecosystem.config.js`中配置：

```javascript
module.exports = {
  apps: [{
    name: 'goodpick-go',
    script: 'npm',
    args: 'run start',
    env: {
      NODE_ENV: 'production',
      DATABASE_URL: 'postgresql://user:password@localhost:5432/goodpick_db',
      JWT_SECRET: 'your-jwt-secret',
      LINE_CHANNEL_ID: '1234567890',
      // ... 其他变量
    }
  }]
};
```

---

## 关键修改说明（Replit → 标准环境）

本项目已移除对Replit专有AI Integrations的依赖，现在可以在任何标准Node.js环境中运行。

### 修改的环境变量

| 旧变量（Replit专用） | 新变量（标准） | 说明 |
|---------------------|---------------|------|
| `AI_INTEGRATIONS_OPENAI_BASE_URL` | `OPENAI_BASE_URL` | OpenAI API基础URL（可选） |
| `AI_INTEGRATIONS_OPENAI_API_KEY` | `OPENAI_API_KEY` | OpenAI API密钥（可选） |

### 兼容性保证

- ✅ **在没有OPENAI_API_KEY的情况下，系统仍可正常运行**
- ✅ 所有API接口（如GET /api/campaigns/:id）都不会因为缺少OpenAI配置而返回500错误
- ✅ 翻译失败时自动使用原文兜底，不影响用户体验

---

## 验证配置

启动服务后，检查日志输出：

### 正常启动（有OpenAI配置）
```
✅ OpenAI翻译服务已启用
[express] serving on port 5000
```

### 正常启动（无OpenAI配置）
```
⚠️ 未配置OPENAI_API_KEY，翻译功能已禁用，将使用原文作为翻译结果
[express] serving on port 5000
```

### 配置错误示例
```
❌ 数据库连接失败: connection refused
```

---

## 故障排查

### 问题1：接口返回500错误 "ECONNREFUSED wss://localhost/v2"

**原因**：代码中残留了Replit AI Integrations的依赖

**解决方案**：
1. 确保使用最新版本的代码（已移除Replit依赖）
2. 检查`server/services/translationService.ts`是否使用了`AI_INTEGRATIONS_*`环境变量
3. 如果仍有问题，设置`OPENAI_API_KEY`或确保代码中所有AI调用都有容错机制

### 问题2：翻译功能不工作

**检查步骤**：
1. 确认已配置`OPENAI_API_KEY`
2. 检查OpenAI API额度是否充足
3. 查看服务器日志中的翻译错误信息

**临时方案**：
- 不配置`OPENAI_API_KEY`，手动编辑各语言版本的活动内容

### 问题3：数据库连接失败

**检查步骤**：
1. 确认PostgreSQL服务已启动
2. 检查`DATABASE_URL`格式是否正确
3. 验证数据库用户权限
4. 测试网络连接：`psql $DATABASE_URL`

---

## 安全建议

1. **永远不要将.env文件提交到Git仓库**
   - 在`.gitignore`中添加`.env`
   
2. **使用强随机密钥**
   - `JWT_SECRET`和`SESSION_SECRET`应使用32位以上随机字符串
   - 可以使用：`openssl rand -base64 32`生成

3. **生产环境专用密钥**
   - 不要在生产环境使用开发环境的密钥
   - 定期轮换API密钥

4. **阿里云RAM权限最小化**
   - OSS访问密钥应只授予必要的Bucket权限
   - 建议使用RAM子账号，而非主账号AccessKey

---

## 参考资料

- [LINE Developers Console](https://developers.line.biz/console/)
- [阿里云OSS文档](https://help.aliyun.com/product/31815.html)
- [OpenAI API文档](https://platform.openai.com/docs/api-reference)
- [PostgreSQL环境变量](https://www.postgresql.org/docs/current/libpq-envars.html)
