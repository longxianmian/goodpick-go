# GoodPick Go H5（Replit 开发环境）——给 Replit AI 代理的下一步开发指令

> 说明：以下所有说明都基于当前 Replit 开发环境 H5 系统，请严格按本指令迭代，不要推翻现有架构（React + 当前后端 + 阿里云 OSS + OpenAI 翻译）。

当前开发环境基础域名（统一称为 **DEV_BASE_URL**）：

* `https://2a3dbd71-d95e-49d6-83ea-2b4612a7e846-00-2q8velw177hcs.worf.replit.dev`

请在后续代码中都通过环境变量读取，不要写死域名。

---

## 一、先把「普通用户」核心领券流程稳定下来

涉及页面：

* `/campaign/:id`  活动详情页（落地页）
* `/my-coupons`   我的优惠券

### 1.1 目标体验

1. 普通用户从 LINE OA 富菜单或外部广告进入：

   * OA 富菜单按钮

     * “优惠活动” → 打开某个活动的 LIFF 链接（目前已配置）
     * “我的优惠券” → 打开 `/my-coupons` 对应的 LIFF 链接
   * 外部渠道（Facebook / TikTok / IG）

     * H5 直链：`DEV_BASE_URL/campaign/:id`

2. 在活动详情页：

   * 未登录：点击“立即领取”，触发 LINE 登录 → 登录成功后只触发一次领券逻辑
   * 已登录：点击“立即领取”，直接调用领券 API
   * 已领取：按钮替换为“查看我的优惠券”，点击跳转 `/my-coupons`

3. `/my-coupons`：

   * 默认按状态分 Tab：全部 / 未使用 / 已使用 / 已过期
   * 能看到当前登录 LINE 用户的券列表

### 1.2 技术要求（请重点改造）

1. **拆清楚前端状态机，避免重复执行领券逻辑**：

   * 不要在多个 `useEffect` 里同时监听 URL 参数 + 登录状态然后各自去领券。
   * 为详情页定义明确的步骤枚举，例如：`INIT` / `CHECK_LOGIN` / `READY` / `CLAIMING` / `CLAIMED`，每一步只在一个地方推进一次。

2. **处理好 `autoClaim` 或类似参数的“一次性消费”**：

   * 如果当前逻辑中通过 query 参数（例如 `?autoClaim=true` 或 `?token=...`）来触发自动领券：

     * 触发一次后，应在前端把这个标记消耗掉（例如重定向到无该参数的 URL，或用本地 state 标记已经处理过）。
     * 避免刷新或二次登录时再次自动领券，造成页面“闪一下、再重新加载”的体验。

3. **统一 LIFF 环境 & 普通浏览器环境的登录流程**：

   * 已经有 LIFF + Web OAuth 的组合实现，不要重写，只需要：

     * 严格区分：

       * LIFF 内 → 尽量用 `liff.login()` + `liff.getIDToken()` 方案。
       * 普通浏览器 → 走 Web OAuth（`/api/auth/line/login` 回调）。
     * 确保不在同一次访问中既触发 LIFF 登录又触发 Web OAuth。

4. **领券接口的错误处理**：

   * 已达到个人上限、活动已结束、券已发完等错误，要在前端有明确弹窗提示，并保持当前页面状态稳定（不要再重定向或重复请求）。

---

## 二、梳理「店员绑定」与「核销登录」逻辑

目前相关模块已经存在（包括门店员工预设、授权二维码、staff 相关路由），不要推翻，只做增强和修正。

### 2.1 店员绑定（/staff/bind）

现状概要（基于现有代码逻辑）：

* 管理后台在“门店管理”中为某门店新增员工预设（姓名、工号、电话），生成 `authToken` 和授权二维码 / 链接。
* 店员扫二维码打开 `/staff/bind?token={authToken}&lang=...`，前端调用 `/api/staff/bind/verify` 拿到预设信息。
* 目前前端有一个“手机号输入 = 纯前端校验”的逻辑，但后端并未真正验证手机号。
* 随后走 LINE OAuth：`state = authToken`，回调 `/api/auth/line/staff-callback`，后端完成：

  * 校验 token 是否存在 / 未过期 / 未绑定
  * 用 code 换 token、验证 id_token
  * 在 `users` 表中创建或查找用户
  * 更新 `staffPresets` 绑定 `boundUserId`

**改造要求：**

1. 手机号校验仅作为“员工确认信息”的本地体验，不要在文案和逻辑上暗示这是强安全校验。

   * 可以保留前端“输入手机号与预设一致才允许继续”的 UI，但要明确这只是防止扫码错人，不是安全边界。

2. 在前端 `StaffBind` 页面上，状态清晰：

   * `loading`：等待 `/verify` 返回
   * `invalid`：token 不存在 / 已过期 / 已被绑定，给出对应错误提示
   * `ready`：展示门店 + 员工预设信息，提示用本人 LINE 扫码绑定
   * `binding`：跳转到 LINE OAuth 中
   * `success`：回调带 `success=true` 时展示绑定成功，并在 2 秒后跳转 `/staff/redeem`

3. 后端 `staff-callback` 保持当前“只信任 authToken + LINE id_token”的安全模型，不新增 phone scope。

   * 同时要对 `state` 参数做好防重放：24h 过期 + 已绑定不可再次绑定。

### 2.2 店员核销（/staff/redeem）

现状概要：

* 店员登录后，前端依赖用户 JWT（type: 'user'）+ `staffAuthMiddleware` 来判断是否为已绑定店员。
* `/api/staff/redeem/query` 根据 8 位核销码查券 + 活动 + 用户，并检查该活动是否属于当前店员所在门店。
* `/api/staff/redeem/execute` 完成状态更新并记录核销门店。

**必须做到：**

1. 核销页面只能在“当前 LINE 用户已绑定为店员”的前提下访问：

   * 未登录或没有有效用户 JWT → 提示“请先使用绑定的 LINE 账号登录” → 引导到登录 / 绑定流程。
   * 有用户 JWT 但未在 `staffPresets` 中绑定 → 提示“您还未绑定店员身份，请联系门店管理员生成授权二维码”。

2. 手动核销码规则统一为 **8 位数字**：

   * 前端输入框仅允许数字，长度必须等于 8，未满足条件时不允许发起查询请求。
   * 后端校验：

     * `code` 必须是 8 位数字字符串
     * 未找到券 → 返回清晰错误信息（例如“核销码不存在”）

3. 核销查询和执行的权限校验：

   * 严格使用 `campaignStores` 表限制只能核销本门店活动的优惠券。
   * 已使用 / 已过期的券要给出区分度高的错误提示。

4. 日志：

   * 核销成功时在后端打印包含：`couponId`、`code`、`staffPresetId`、`storeId`、`usedAt` 的日志，便于排查。

---

## 三、多语言体系：UI 和动态内容的职责划分

本系统是多语言系统，需要明确两层：

### 3.1 系统 UI 文案

* 所有 UI 文案（按钮、标题、提示语）统一使用前端国际化方案（例如 i18n 字典）。
* 语言切换逻辑沿用现有实现：用户在 H5 选择语言后，整个 UI 语言随之切换。
* Replit 端不要再为 UI 文案调用 OpenAI 翻译。

### 3.2 动态内容（活动 / 规则 / 培训等）

* 动态内容包括但不限于：

  * 活动标题、活动简介、活动规则
  * 店员培训说明、活动注意事项、统计说明等富文本内容
* 这些内容在 **创建 / 编辑时** 由后台调用 OpenAI 翻译：

  * 源语言字段：`*_source_lang` + `*_source`
  * 目标语言字段：`*_zh` / `*_en` / `*_th` 等
* 翻译失败时：

  * 不要在前端临时去调用 OpenAI 兜底
  * 后端记录错误日志 + 在管理后台提供“重新翻译”按钮
* 前端所有详情页只从数据库读取已保存的多语言字段，不再动态调用 OpenAI。

> 总结：**UI 文案靠前端 i18n，动态内容靠后台一次性翻译后入库，前端只读。**

---

## 四、门店距离显示：允许失败，保证页面稳定

现状：

* 在普通浏览器中打开时可以计算当前位置到门店的距离。
* 在 LINE WebView 中，有时无法获取 geolocation，导致距离不显示。

处理要求：

1. 使用 `navigator.geolocation` 时必须处理报错分支：

   * 如果获取失败，不要报错或让页面崩溃，只是隐藏“距离”字段，保留门店地址、导航按钮。
   * 可选：显示“无法获取当前定位，只展示门店地址”。

2. 所有与地图 / 导航有关的功能都要在地理位置授权失败时保持可用（至少能点击导航打开地图 App）。

---

## 五、数据面板（/admin/dashboard）开发要求

数据面板面向系统管理员，用于按月查看整体运营情况。要求：

### 5.1 维度设计

1. 活动维度

   * 统计周期：按月（可选择月份）
   * 每个活动展示：

     * 活动名称
     * 所参与门店数量
     * 总领券数量
     * 总核销数量
     * 核销率 = 核销数量 / 领券数量

2. 品牌维度

   * 品牌示例：Banana、7-Eleven、KFC 等
   * 每个品牌展示：

     * 参与活动数量
     * 覆盖门店数量
     * 领券数量
     * 核销数量
     * 核销率

3. 门店维度

   * 每个门店展示：

     * 所参与活动数量
     * 领券数量
     * 核销数量
     * 核销率

### 5.2 数据来源与实现建议

* 基于现有表结构：`campaigns`、`stores`、`campaignStores`、`coupons` 等聚合计算。
* 后端提供统一统计 API（例如 `/api/admin/dashboard?month=2025-11`）：

  * 返回上述三个维度的数据结构
  * 由前端进行图表 / 表格展示（表格 + 简单柱状图即可）。
* 注意：

  * 所有统计均应按券的 `issuedAt` / `usedAt` 时间落入对应月份
  * 对于无数据的活动 / 品牌 / 门店，可选地用 0 填充或在 UI 做筛选

---

## 六、开发环境与生产环境的界限（给后续迁移做准备）

虽然目前只在 Replit 开发环境中运行，但请在代码层面做好「可迁移」设计：

1. 所有对域名的引用必须通过环境变量：

   * 后端：`BASE_URL`（用于 LINE 回调、生成授权链接等）
   * 前端：`VITE_API_BASE_URL`、`VITE_LIFF_ID`、`VITE_LINE_CHANNEL_ID` 等

2. 不要在代码中写死 Replit 的 worf 域名和 LIFF URL，只保留：

   * `LIFF_ID` / `LINE_CHANNEL_ID` / `LINE_CHANNEL_SECRET`
   * 回调路径（相对路径，例如 `/api/auth/line/callback`、`/api/auth/line/staff-callback`）

3. 后续迁移到阿里云时，只需要：

   * 更新环境变量中的 BASE_URL / VITE_API_BASE_URL / LIFF Endpoint
   * 在 LINE Developers 中更新 Callback URL / LIFF URL
   * 不需要大改代码。

---

## 七、执行顺序建议

请 Replit AI 代理按下面顺序迭代，避免到处改造成新的混乱：

1. **先稳定普通用户流程**（活动详情 + 我的优惠券 + 单次领券逻辑）
2. **再梳理并打通店员绑定 / 核销流程**（含 8 位核销码规则）
3. **完成多语言体系的职责拆分与后台翻译逻辑**
4. **修复定位失败时的页面表现**
5. **实现管理后台的数据面板（按月统计）**
6. **最后再清理环境变量和域名依赖，为后续迁移到阿里云做准备**

请在每一步改动时：

* 尽量复用 mevcut 代码和接口，不要重写整套登录 / 存储逻辑
* 增加必要的日志输出，便于在 Replit Console 中排查问题
* 所有新增接口 / 重要修改，请在项目文档中补充说明。
