重要说明：请严格按以下范围修改，不要做大范围重构。


不要改动 LINE 登录 / LIFF / 后端 API 逻辑


不要改动多语言翻译 / OpenAI 部分


只允许在「活动详情页前端代码」和相关路由上做最小修改，解决重复请求 & 路由切换问题




一、问题背景（请你先对照日志确认）
当前现象是：


从 LINE OA 底部菜单「优惠活动」进入活动详情页（LIFF 打开的 H5），
/api/campaigns/1 首屏现在只请求 1 次，这个没问题。


在详情页底部 tab 里来回切换：


先点「我的优惠券」→ 调用 /api/me/coupons


再点「优惠活动」回到详情页


回到「优惠活动」之后，服务器日志显示：在我不做任何操作的情况下，/api/campaigns/1 被重复请求多次，例如：


12:32:55  – GET /api/campaigns/1  （切回那一刻，这是正常的）


12:33:00  – GET /api/campaigns/1  （5 秒后，又来一次 ❌）


12:33:15  – GET /api/campaigns/1  （15 秒后，再来一次 ❌）


12:33:20  – GET /api/campaigns/1  （20 秒后，再来一次 ❌）


这个就是我在手机上看到的“详情页好像又刷新了一下”的根源。


请你以这段日志为依据来定位问题，而不是靠猜。

二、目标（必须达成）


活动详情接口 GET /api/campaigns/:id 在一个页面停留期间只请求必要次数：


首次进入详情页：1 次


从底部 tab「我的优惠券」切回「优惠活动」：最多再 1 次


切回后，如果用户不操作，不应该有额外的自动请求。




底部 tab 的切换（优惠活动 / 我的优惠券）只在前端做视图切换：


不要因为切 tab 导致整个路由卸载 / 重新挂载，除非确实需要


不能再出现那种「切回后过几秒又自动刷新详情」的现象




不要破坏已有的行为：


普通用户 OA 的「优惠活动」入口 ➜ LIFF 链接 ➜ 活动详情页


详情页内部「用 LINE 一键领取」逻辑


「查看我的优惠券」流程


多语言切换（中文 / 泰文 / 英文）





三、修改范围 & 禁止事项
允许修改：


client/src/pages/CampaignDetail.tsx（或者现在活动详情页对应的组件文件）


与活动详情页相关的前端路由配置


与这个页面相关的 React Query 配置（只针对活动详情那个 query）


禁止修改：


后端 routes.ts 和任何数据库结构


LINE / LIFF / OAuth / JWT 相关逻辑


OpenAI 翻译和多语言存储逻辑


管理员后台、店员核销相关代码


不要引入新的状态管理库，不要重写 Router



四、请按下面步骤排查并修复
第 1 步：加最小日志，确认前端行为（临时，调试用）
在活动详情组件里只加少量 console.log，例如：


组件 mount / unmount 次数：
useEffect(() => {
  console.log('[CampaignDetail] mounted at', new Date().toISOString());
  return () => console.log('[CampaignDetail] unmounted at', new Date().toISOString());
}, []);



活动详情 useQuery 的 onSuccess 里打一条：
const campaignQuery = useQuery(
  ['campaign', id],
  ...,
  {
    ...,
    onSuccess: () => {
      console.log('[CampaignDetail] campaign data fetched at', new Date().toISOString());
    }
  }
);



不要改逻辑，只用来对齐“组件挂载次数”和“接口请求时间”。
验证场景：


从 OA 菜单点「优惠活动」进入详情页


点底部「我的优惠券」


再点底部「优惠活动」


停留 30 秒不要点任何东西


然后对比：


服务器的 /api/campaigns/:id 日志时间


浏览器 console 中的 [CampaignDetail] mounted 和 [campaign data fetched] 日志时间


看清楚是组件多次 mount，还是 同一组件内被反复触发 fetch。
第 2 步：修复重复请求逻辑（保持最小修改）
根据日志分析，大概率有几个典型原因，你按顺序排查：


React Query 的 key 或 enabled 条件写得不当


确保活动详情的 useQuery key 是稳定的，比如：
useQuery(['campaign', campaignId], ...)



不要把 view、tab 或 location 等变化的东西放进这个 key 里。


配置中明确禁止自动刷新：
{
  staleTime: Infinity,
  refetchOnWindowFocus: false,
  refetchOnReconnect: false,
  refetchOnMount: false,
  refetchInterval: false
}



检查有没有 useEffect 里手动调用 refetch() 或 queryClient.invalidateQueries(['campaign', id])，如果只是为了“切语言”，要保证不会在不必要的时候触发多次。




底部 tab 的切换方式


如果现在底部 tab 是通过改变 URL（比如 ?view=campaign / ?view=my-coupons），注意不要因为 view 变化导致整个 CampaignDetail 用不同的 React key 重新挂载。


推荐的做法：


URL 里允许带 view 参数，但 CampaignDetail 自己保持不变；


用一个内部状态 activeTab 来决定显示「活动内容」还是「我的优惠券」，而不是每次都让路由层重新挂载组件；


或者用 wouter 的嵌套路由，但确保 QueryProvider / AuthProvider 这些不随 view 改变。






清理定时器 / 轮询


搜索整个前端项目有没有针对活动详情设置 setInterval / setTimeout 去轮询 campaign：


如果有，请取消这类轮询逻辑，我们的业务不需要自动轮询活动详情。




如果一定要保留某种定时刷新，请至少保证：


只在明确需要的场景（比如倒计时）才触发；


且不会影响 /api/campaigns/:id 的请求（使用本地状态即可）。






第 3 步：验证修复结果
修复后请按以下场景测试（普通浏览器 + LIFF 环境都测一次）：


从 OA 的「优惠活动」按钮进来：


服务器 /api/campaigns/:id 只打一枪；


console 里 mounted / campaign fetched 一一对应。




在详情页底部：


点「我的优惠券」→ API /api/me/coupons 正常一次；


点「优惠活动」回去后：


/api/campaigns/:id 至多再打一枪；


之后静置 30 秒，不应该再出现额外的 /api/campaigns/:id 请求。






多语言切换 / LINE 登录 / 领券逻辑都要再走一遍，确保没被这次修改破坏。


确认无误后，把调试用的 console.log 去掉（或保留 1~2 条不影响性能的）。

五、关于 OA 底部菜单（说明即可，不必改代码）

这一条主要是给你了解场景，代码基本不用改：



用户侧 H5 页面底部已经有「优惠活动 / 我的优惠券」两个 tab。


LINE Official Account 的富菜单里，我只需要 保留一个入口“优惠活动”，指向活动的 LIFF URL；


「我的优惠券」入口以后只在 H5 底部 tab 里出现，不要再在 OA 里单独做一个菜单按钮。


这部分配置我会在 LINE OA 后台自己调整，你只要确保：


当用户从 LIFF 入口进来时：


默认是 view=campaign，展示活动详情；


底部点击「我的优惠券」会切换到 view=my-coupons 或等价逻辑；


不要因为 view 切换导致重复请求活动详情接口。






总结：
请你只针对「活动详情页重复请求 /api/campaigns/:id」这个问题，按上面的步骤 先用日志确认原因，再做最小范围的修复。
完成后把你修改的关键代码片段和新的日志（时间线）贴出来，让我能看懂你改了什么、为什么现在不会再重复请求。

