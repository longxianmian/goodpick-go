# Goodpick-Go：阿里云“转码工作流 + OSS”接入开发文档（交给 ReplitAI 执行）

> 目标：上传原始 MP4 到 OSS 后，自动触发阿里云转码工作流产出 **HLS（m3u8 + ts/m4s）**，并将 `hlsUrl` 回写到数据库；前端优先播放 HLS，MP4 作为兜底。

---

## 0. 前置说明（你已完成）

* 已有 OSS 存储桶、已在阿里云配置转码“工作流/模板/输入输出桶”。
* 现在接口返回：

  * `videoUrl`: 指向 OSS 的 mp4 直链
  * `hlsUrl`: 当前为 `null`（需要本任务接入后回写）

---

## 1. 最终交付验收（必须满足）

### 1.1 后端

* 上传视频后，DB 中该视频记录：

  * `videoUrl` 存 MP4 直链
  * `hlsUrl` 存 m3u8 直链（可为空，直到转码完成）
  * `transcodeStatus`：`PENDING | PROCESSING | SUCCESS | FAILED`
  * `transcodeJobId`（可选）
* 新增回调接口：阿里云转码工作流完成后能回调到后端，后端能识别并回写 `hlsUrl`。
* 全链路日志可追踪：从上传 → 触发 → 回调 → 回写。

### 1.2 前端

* 播放优先级：`hlsUrl` 存在则播放 HLS，否则播放 `videoUrl`。
* HLS 播放：

  * Safari 走原生 `<video src="m3u8">`
  * Chrome/Android/大部分浏览器用 `hls.js`
* 上下滑沉浸式播放：至少保证 mp4 也能 Range 206；HLS 完成后体验更稳。

---

## 2. 环境变量（生产）

> 注意：不要把 AccessKey 写进 Git；用平台环境变量/Secrets。

### 2.1 OSS

* `OSS_REGION`：例如 `oss-ap-southeast-1`
* `OSS_BUCKET`：例如 `shuashua-video`
* `OSS_ACCESS_KEY_ID`
* `OSS_ACCESS_KEY_SECRET`

### 2.2 转码工作流（按你阿里云实际配置填）

> 你已经在阿里云控制台建了工作流/管道/回调；这里只要求把 ID/回调密钥配置进环境变量。

* `MPS_WORKFLOW_ID`：工作流 ID
* `MPS_PIPELINE_ID`：管道 ID（如你工作流需要）
* `MPS_CALLBACK_URL`：回调地址（你的服务公网）
* `MPS_CALLBACK_KEY`：回调签名密钥（如果你在控制台配置了）

> 如果你使用的是“点播 VOD”的工作流而不是 MPS：把变量名对应改成 VOD 的（保持结构一致），但实现思路不变。

---

## 3. 数据库改动（Drizzle / SQL 二选一实现）

### 3.1 在 short_videos 表新增字段（推荐）

* `hls_url` TEXT NULL
* `transcode_status` TEXT NOT NULL DEFAULT 'PENDING'
* `transcode_job_id` TEXT NULL
* `transcode_error` TEXT NULL
* `transcoded_at` TIMESTAMP NULL

#### SQL（示例）

```sql
ALTER TABLE short_videos
  ADD COLUMN IF NOT EXISTS hls_url text,
  ADD COLUMN IF NOT EXISTS transcode_status text NOT NULL DEFAULT 'PENDING',
  ADD COLUMN IF NOT EXISTS transcode_job_id text,
  ADD COLUMN IF NOT EXISTS transcode_error text,
  ADD COLUMN IF NOT EXISTS transcoded_at timestamptz;

CREATE INDEX IF NOT EXISTS idx_short_videos_transcode_status
  ON short_videos(transcode_status);
```

---

## 4. 后端实现：触发转码 + 回调写库

### 4.1 触发时机（上传成功后）

当用户上传 MP4 成功写入 OSS 后：

1. 先写入 DB（videoUrl、status=PENDING）
2. 调用阿里云转码工作流 API 触发任务（携带 input objectKey）
3. 把返回的 jobId 存到 DB（status=PROCESSING）

> 如果你已经在阿里云配置“OSS 事件触发工作流”，那步骤2可以省略：你只需做回调接入 + 回写。

**要求 ReplitAI 先判断你当前用的是哪种触发：**

* A. 由后端调用 API 触发
* B. 由 OSS 事件自动触发工作流（更省后端）

默认按 **B** 实现（最少代码），若发现你不是 B 再切换到 A。

### 4.2 回调接口（核心）

新增路由（示例）：

* `POST /api/transcode/callback`

回调输入（按阿里云回调格式解析，字段名可能不同，需以你控制台实际回调 payload 为准）：

* `input.bucket`
* `input.object`
* `outputs[]`：包含 m3u8 的 objectKey/URL
* `status`：SUCCESS/FAILED
* `jobId`

**回调处理逻辑：**

1. 验证签名（若有）：校验 `MPS_CALLBACK_KEY`
2. 从 payload 里定位：

   * 原视频 input 的 objectKey（用于关联 DB）
   * 产物 m3u8 的 objectKey（用于生成 hlsUrl）
3. 生成 hlsUrl（统一用 env 组合 URL）：

   * `https://{OSS_BUCKET}.{OSS_REGION}.aliyuncs.com/{m3u8_objectKey}`
4. 更新 DB：

   * `hls_url = hlsUrl`
   * `transcode_status = SUCCESS`
   * `transcoded_at = now()`
   * 失败则写 `FAILED + transcode_error`

### 4.3 如何把“input objectKey”关联到 DB（最稳做法）

上传写入 OSS 的 objectKey 当前类似：

* `user/1/1765622764360-y2w5oo.mp4`

建议在 short_videos 表新增/已有字段：

* `video_object_key`（存 objectKey，不是 url）

这样回调只要拿到 input.objectKey 就能精确更新。

---

## 5. 前端播放改造（HLS 优先）

### 5.1 播放策略

* 如果 `hlsUrl` 非空：

  * Safari：`<video src={hlsUrl} />`
  * 其他：hls.js
* 否则：使用 `videoUrl` 的 mp4 直链

### 5.2 需要新增依赖

* `hls.js`

### 5.3 关键注意点

* 列表页（沉浸式上下滑）要做：

  * 预加载下一条（HLS 可以预取 m3u8；MP4 可预取头部 Range）
  * 切换时复用 `<video>` 节点减少闪烁

---

## 6. CORS 与 Range（播放必备）

### 6.1 OSS CORS

需要允许你的域名访问 OSS 资源：

* Origin：`https://www.goodpickgo.com`（可加 test 域名）
* Methods：`GET, HEAD`
* Allow-Headers：`*`
* Expose-Headers：建议包含 `Content-Range, Accept-Ranges, ETag`

### 6.2 验证命令（服务器执行）

```bash
# HLS: 检查 m3u8 是否可访问
curl -I "<HLS_M3U8_URL>"

# MP4: Range 是否 206
curl -s -o /dev/null -D - -H "Range: bytes=0-1023" "<MP4_URL>" | head -n 20
```

---

## 7. 代码落点（建议文件结构）

### 7.1 新增模块

* `server/services/transcodeService.ts`

  * 触发任务（如果你用 A）
  * 解析回调 payload
  * 生成 hlsUrl
* `server/routes/transcode.routes.ts`

  * `POST /api/transcode/callback`

### 7.2 修改现有

* `server/services/aliOssService.ts`

  * 上传成功后：返回 objectKey
* `server/modules/short-videos/*.ts`（或现有上传处理处）

  * 保存 `video_object_key`
  * 初始化 `transcode_status`
* `GET /api/short-videos/:id`

  * 返回 `hlsUrl`

---

## 8. 开发步骤（ReplitAI 按顺序执行）

1. 新增 DB 字段 + migration
2. 上传流程保存 `video_object_key` + `transcode_status=PENDING`
3. 新增回调接口 `/api/transcode/callback`
4. 根据你阿里云回调 payload 完成解析与写库（SUCCESS/FAILED）
5. 前端引入 hls.js，并做 HLS 优先播放
6. 写 2 个最小测试脚本：

   * 模拟回调（本地 POST callback）
   * 播放验证（访问 m3u8 返回 200 + mp4 Range 206）

---

## 9. 最小模拟回调（用于开发自测）

> 真实 payload 以你阿里云回调为准，这里只给结构。

```bash
curl -X POST https://www.goodpickgo.com/api/transcode/callback \
  -H 'Content-Type: application/json' \
  -d '{
    "jobId": "test-job-1",
    "status": "SUCCESS",
    "input": {"bucket":"shuashua-video","object":"user/1/1765622764360-y2w5oo.mp4"},
    "outputs": [{"object":"hls/user/1/1765622764360-y2w5oo/playlist.m3u8"}]
  }'
```

---

## 10. 备注：当前系统已发现的两个问题（本任务之外）

* `invite_scene` enum 缺少 `line_share`：需要 DB enum 增补（后续单独任务）
* 未配置 `OPENAI_API_KEY` 导致翻译禁用：可后续补齐

---

## 11. 交付物清单（ReplitAI 必须提交）

* [ ] DB migration（或 SQL）
* [ ] `/api/transcode/callback` 实现 + 日志
* [ ] `hlsUrl` 回写逻辑
* [ ] 前端 HLS 播放实现（hls.js + Safari fallback）
* [ ] 最小自测脚本/说明

---

## 12. 需要你提供给 ReplitAI 的控制台信息（由你在 Replit 填入 Secrets）

* `MPS_WORKFLOW_ID`（或 VOD 的 workflow/job 模板 ID）
* `MPS_CALLBACK_KEY`（如启用签名校验）
* 回调 payload 示例（你从阿里云回调日志复制一份）

> ReplitAI 若拿不到回调 payload 样例：必须先实现“接收原样 payload 并落日志”的版本，再迭代解析。
