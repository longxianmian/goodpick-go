# GoodPick / DeeCard OA æ´»åŠ¨å¹¿æ’­ v1ï¼ˆStep 7ï¼‰

> ç›®æ ‡ï¼šåœ¨ç®¡ç†åå°é‡Œï¼Œè¿è¥å¯ä»¥å¯¹æŸä¸ªæ´»åŠ¨æ‰‹åŠ¨ç‚¹å‡»ä¸€æ¬¡æŒ‰é’®ï¼Œ
> ç”± DeeCard OA ç»™æ‰€æœ‰å·²ç»‘å®šä¼šå‘˜æ¨é€ä¸€æ¡ã€Œæ–°æ´»åŠ¨æé†’ã€æ¶ˆæ¯ã€‚

---

## 1. ä½¿ç”¨åˆ°çš„å·²æœ‰æ•°æ®è¡¨

æœ¬åŠŸèƒ½åªåŸºäºç°æœ‰è¡¨ï¼Œä¸å†æ–°å¢è¡¨ï¼š

- `campaigns`ï¼šæ´»åŠ¨ä¸»è¡¨ï¼ˆå·²æœ‰ï¼‰
- `campaign_broadcasts`ï¼šæ´»åŠ¨å¹¿æ’­ä»»åŠ¡è¡¨ï¼ˆStep 3 å·²å»ºç«‹ï¼‰
- `oa_user_links`ï¼šOA ä¸ LINE ç”¨æˆ·ç»‘å®šè¡¨ï¼ˆStep 2 å·²å»ºç«‹ï¼‰
- `users`ï¼šå¹³å°ç”¨æˆ·è¡¨ï¼ˆå·²æœ‰ï¼Œå« `preferred_language` å­—æ®µï¼‰

æšä¸¾ï¼š

- `broadcast_status`ï¼š'pending' | 'sending' | 'done' | 'failed' | 'cancelled'
- `preferred_language`ï¼š'th' | 'en' | 'zh'

ç¯å¢ƒå˜é‡ï¼š

- `GOODPICK_MAIN_OA_ID`ï¼ˆå·²åœ¨ Step 5 ä½¿ç”¨ï¼‰
- `LINE_CHANNEL_ACCESS_TOKEN`ï¼ˆStep 6 å·²ä½¿ç”¨ï¼‰

---

## 2. ä¸šåŠ¡è§„åˆ™ï¼ˆv1 ç®€åŒ–ç‰ˆï¼‰

1. **è°èƒ½è§¦å‘å¹¿æ’­ï¼Ÿ**
   - åªå…è®¸ç®¡ç†å‘˜åœ¨ã€Œæ´»åŠ¨è¯¦æƒ…é¡µã€é‡Œæ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ã€‚
   - ä¸åšå®šæ—¶ä»»åŠ¡ / CRONï¼Œå…ˆå®ç°ã€Œç‚¹å‡»å³å‘ã€ç‰ˆæœ¬ã€‚

2. **å‘ç»™è°ï¼Ÿ**
   - ä» `oa_user_links` ä¸­æŸ¥å‡ºï¼š
     - `oa_id = GOODPICK_MAIN_OA_ID`
   - åªè¦è¿™æ¡ OA ç»‘å®šè¿‡çš„ç”¨æˆ·éƒ½ç®—ç›®æ ‡ï¼ˆä¸åŒºåˆ†æ˜¯å¦å·²ç»é¢†è¿‡è¯¥æ´»åŠ¨ï¼‰ã€‚

3. **è¯­è¨€è§„åˆ™ï¼š**
   - å…ˆç”¨ `users.preferred_language`ï¼›
   - æ²¡æœ‰çš„è¯ï¼Œç”¨ `oa_user_links.initial_language`ï¼›
   - ä»ç„¶æ²¡æœ‰æ—¶å…œåº• `'th'`ã€‚
   - v1 ç”¨ **åŒä¸€æ¡æ¨¡æ¿ï¼Œåªæ˜¯è¯­è¨€ä¸åŒ**ï¼Œä¸åšä¸ªæ€§åŒ–å†…å®¹ã€‚

4. **æ¶ˆæ¯å†…å®¹ï¼ˆv1 æ™®é€šæ–‡æœ¬å³å¯ï¼‰ï¼š**

   - Thaiï¼ˆ`th`ï¼‰ç¤ºä¾‹ï¼š

     > ğŸ‰ à¸¡à¸µà¸”à¸µà¸¥à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸ DeeCard à¹à¸¥à¹‰à¸§!  
     > à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹à¸¥à¸°à¸£à¸±à¸šà¸ªà¸´à¸—à¸˜à¸´à¹Œà¸‚à¸­à¸‡à¸„à¸¸à¸“: \<æ´»åŠ¨è¯¦æƒ…é¡µé“¾æ¥\>

   - Englishï¼ˆ`en`ï¼‰ç¤ºä¾‹ï¼š

     > ğŸ‰ New offer is now available on DeeCard!  
     > Tap to view details and claim your coupon: \<æ´»åŠ¨è¯¦æƒ…é¡µé“¾æ¥\>

   - Chineseï¼ˆ`zh`ï¼‰ç¤ºä¾‹ï¼š

     > ğŸ‰ DeeCard æœ‰æ–°çš„ä¼˜æƒ æ´»åŠ¨ä¸Šçº¿å•¦ï¼  
     > ç‚¹å‡»æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…å¹¶é¢†å–ä½ çš„ä¼˜æƒ åˆ¸ï¼š\<æ´»åŠ¨è¯¦æƒ…é¡µé“¾æ¥\>

   - å…¶ä¸­ã€Œæ´»åŠ¨è¯¦æƒ…é¡µé“¾æ¥ã€ä¸º **ç”Ÿäº§ç¯å¢ƒ H5 æ´»åŠ¨è¯¦æƒ…åœ°å€**ï¼š
     - `https://goodpickgo.com/campaign/<campaignId>`ï¼ˆä¸å‰ç«¯ç°æœ‰è·¯ç”±ä¿æŒä¸€è‡´ï¼‰

5. **å‘é€æ–¹å¼ï¼š**
   - v1 ä¸ºäº†ç®€å•èµ·è§ï¼Œå¯ä»¥ä½¿ç”¨ **é€ä¸ªè°ƒç”¨ `pushMessage`** çš„æ–¹å¼ï¼›
   - ä¹‹åå†æœ‰éœ€è¦å†ä¼˜åŒ–ä¸º `multicast`ã€‚

6. **å¹‚ç­‰æ€§ä¸çŠ¶æ€ï¼š**
   - æ¯æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œéƒ½æ–°å»ºä¸€æ¡ `campaign_broadcasts` è®°å½•ï¼›
   - ä¸é™åˆ¶åŒä¸€ä¸ªæ´»åŠ¨è¢«å‘é€å¤šæ¬¡ï¼›
   - å‘é€è¿‡ç¨‹ä¸­æ›´æ–°ï¼š
     - `totalTargets`
     - `sentCount`
     - `failedCount`
     - `status`

---

## 3. åç«¯å®ç°

### 3.1 æ–°å»ºæœåŠ¡ï¼š`server/services/broadcastService.ts`

åŠŸèƒ½ï¼š

1. `createCampaignBroadcast(campaignId: number, adminId: number, oaId: string): Promise<CampaignBroadcast>`
   - åœ¨ `campaign_broadcasts` è¡¨æ–°å»ºä¸€æ¡è®°å½•ï¼š
     - `campaignId`
     - `oaId`
     - `targetType = 'ALL'`
     - `sendTime = new Date()`ï¼ˆç«‹å³å‘é€ï¼‰
     - `status = 'pending'`
     - è®¡æ•°å­—æ®µåˆå§‹åŒ–ä¸º 0
     - `createdBy = adminId`

2. `runBroadcastTask(broadcastId: number): Promise<void>`
   - æ ¸å¿ƒå‘é€é€»è¾‘ï¼š
     1. è¯»å– `campaign_broadcasts` è®°å½•ï¼Œè‹¥ä¸å­˜åœ¨æˆ– `status` â‰  'pending'ï¼Œç›´æ¥è¿”å›ã€‚
     2. æŸ¥ `oa_user_links`ï¼š
        - `oa_id = broadcast.oaId`
     3. ç»Ÿè®¡ç›®æ ‡ç”¨æˆ·æ•°ï¼Œå†™å…¥ `totalTargets`ã€‚
     4. é€šè¿‡ `userId` å…³è” `users` è¡¨ï¼Œæ‹¿åˆ° `preferred_language`ã€‚
     5. å¯¹æ¯ä¸ªç”¨æˆ·è®¡ç®—æœ€ç»ˆè¯­è¨€ï¼š
        - `const lang = user.preferred_language ?? oaUserLink.initial_language ?? 'th'`
     6. æŒ‰ **ç”¨æˆ·ä¸ºå•ä½å¾ªç¯**ï¼š
        - ä½¿ç”¨ Step 6 çš„ `lineMessagingService` æ–°å¢ä¸€ä¸ª helperï¼š
          - `sendCampaignMessage(lineUserId: string, lang: 'th' | 'en' | 'zh', payload: { campaignId: number })`
        - è°ƒç”¨æ—¶ä¼ å…¥ï¼š
          - `lineUserId`
          - `lang`
          - `campaignId`
        - åœ¨ `lineMessagingService` å†…éƒ¨æ‹¼å¥½æ–‡æ¡ˆä¸é“¾æ¥ï¼Œè°ƒç”¨ LINE Messaging API çš„ `pushMessage`ã€‚
     7. ç»Ÿè®¡æˆåŠŸ / å¤±è´¥æ•°é‡ï¼Œæ›´æ–°ï¼š
        - `sentCount`
        - `failedCount`
        - `status`ï¼š
          - å…¨éƒ¨æˆåŠŸ â†’ `'done'`
          - æœ‰å¤±è´¥ â†’ `'failed'`
     8. æ•´ä¸ªè¿‡ç¨‹éœ€è¦ try/catchï¼š
        - å‘ç”Ÿè‡´å‘½é”™è¯¯æ—¶ï¼Œå°† `status` æ ‡è®°ä¸º `'failed'`ï¼Œå¹¶è®°å½•æ—¥å¿—ã€‚

> æ³¨æ„ï¼šv1 ä¸éœ€è¦é˜Ÿåˆ— / åå°ä»»åŠ¡ï¼Œç›´æ¥åœ¨è¯·æ±‚é‡Œä¸²è¡Œå‘é€å³å¯ã€‚

### 3.2 æ‰©å±• `server/services/lineMessagingService.ts`

æ–°å¢å‡½æ•°ï¼š

```ts
export async function sendCampaignMessage(
  lineUserId: string,
  lang: 'th' | 'en' | 'zh',
  payload: { campaignId: number },
) {
  // 1. æ ¹æ® lang é€‰æ‹©æ–‡æ¡ˆæ¨¡æ¿
  // 2. ç»„è£…æ´»åŠ¨é“¾æ¥ï¼šhttps://goodpickgo.com/campaign/${payload.campaignId}
  // 3. ä½¿ç”¨ pushMessage(lineUserId, message) å‘é€
}
